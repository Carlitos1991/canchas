<!DOCTYPE html>
<!-- El 'data-theme' se usa para cargar el modo guardado (claro/oscuro) antes de que todo cargue -->
<html lang="es" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Canchas{% endblock %}</title>

    {% load static %}

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="{% static 'media/icono.png' %}">

    <!-- Font Awesome (Local) -->
    <link rel="stylesheet" href="{% static 'css/all.min.css' %}">

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Hoja de Estilos Principal -->
    <link rel="stylesheet" href="{% static 'css/style.css' %}?v=20251128v2">
    
    <!-- Hoja de Estilos de Animaciones del Sidebar -->
    <link rel="stylesheet" href="{% static 'css/sidebar-animations.css' %}">
    
    <!-- Hoja de Estilos de Dashboard Moderno -->
    <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
    
    <!-- Hoja de Estilos de Autenticación -->
    <link rel="stylesheet" href="{% static 'css/auth.css' %}?v=20251128v7">
</head>

<!--
  El <body> necesita saber si el usuario está logueado o no
  para aplicar los estilos correctos.
-->
<body class="{% if not user.is_authenticated %}logged-out{% endif %}">

{% if user.is_authenticated %}
    <!-- =================================== -->
    <!--     NUEVO SIDEBAR                 -->
    <!-- =================================== -->
    <aside class="sidebar">
        <!-- Encabezado del Sidebar (Logo) -->
        <div class="sidebar-header">
            <div class="sidebar-brand">
                <img src="{% static 'media/icono.png' %}" alt="Logo" class="sidebar-logo">
                <span class="sidebar-brand-text">Canchas</span>
            </div>
        </div>

        <!-- Navegación Principal -->
        <nav class="sidebar-nav">
            {% for item in sidebar_menu %}
                <!-- La lógica de 'active' compara la URL actual o el nombre de la vista -->
                <a href="{{ item.url }}"
                   class="nav-link {% if request.resolver_match.url_name == item.active_check %}active{% endif %} {{ item.class|default:'' }}"
                   title="{{ item.label }}">
                    <div class="nav-icon">
                        <i class="fa-solid {{ item.icon }}"></i>
                    </div>
                    <span class="nav-text">{{ item.label }}</span>
                </a>
            {% endfor %}

            <!-- Separador visual -->
            <hr>

            <!-- Perfil del usuario (siempre visible) -->
            <a href="{% url 'profile' %}"
               class="nav-link {% if request.resolver_match.url_name == 'profile' %}active{% endif %}"
               title="Mi Perfil">
                <div class="nav-icon">
                    <i class="fa-solid fa-user-gear"></i>
                </div>
                <span class="nav-text">Mi Perfil</span>
            </a>
        </nav>

        <!-- Pie de Sidebar (Perfil del Usuario) -->
        <div class="sidebar-footer">
            <!-- Perfil del Usuario -->
            <div class="sidebar-profile">
                <!-- Avatar con inicial del usuario -->
                <img src="https://placehold.co/42x42/10B981/FFFFFF?text={{ user.username.0|upper }}"
                     alt="Avatar"
                     class="profile-avatar"
                     onerror="this.src='https://placehold.co/42x42/10B981/FFFFFF?text=?'">

                <div class="profile-info">
                    <span class="profile-name">
                        {{ user.persona.nombre|default:user.username }}
                    </span>
                    <span class="profile-role">
                        {% if user.persona.rol %}
                            {{ user.persona.get_rol_display }}
                        {% elif user.is_superuser %}
                            Administrador
                        {% else %}
                            Usuario
                        {% endif %}
                    </span>
                </div>

                <!-- Botón de Logout -->
                <form method="post" action="{% url 'logout' %}" class="form-logout">
                    {% csrf_token %}
                    <button type="submit" class="btn-logout" title="Cerrar Sesión">
                        <i class="fa-solid fa-right-from-bracket"></i>
                    </button>
                </form>
            </div>
        </div>
    </aside>
{% endif %}

<!-- =================================== -->
<!--     CONTENEDOR DE PÁGINA ÚNICO    -->
<!-- --- CORRECCIÓN DEL ERROR 'block content' DUPLICADO --- -->
<!-- =================================== -->
<!--
-->
<main class="{% if user.is_authenticated %}main-content{% else %}main-container{% endif %}">
    <!-- Banner informativo cuando el admin está en vista de cliente -->
    {% if vista_cliente_activa %}
    <div class="admin-vista-cliente-banner">
        <div class="banner-content">
            <i class="fa-solid fa-eye"></i>
            <span>Estás viendo el sistema como <strong>Cliente</strong></span>
            <a href="{% url 'toggle_vista_cliente' %}" class="btn-volver-admin">
                <i class="fa-solid fa-user-shield"></i> Volver a Admin
            </a>
        </div>
    </div>
    {% endif %}
    
    {% block content %}{% endblock %}
</main>


<!-- =================================== -->
<!--     SCRIPTS GLOBALES              -->
<!-- =================================== -->

<!-- JS para el login (animación, etc) -->
<script src="{% static 'js/auth.js' %}"></script>

<!-- NUEVO JS para el sidebar y modo oscuro -->
<script src="{% static 'js/main.js' %}"></script>
</body>
</html>