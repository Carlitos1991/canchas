{% extends "templates/base.html" %}
{% load static %}

{% block title %}Buscar Canchas{% endblock %}

{% block content %}
    <div class="content-container">
        <div class="header-section">
            <h1 class="page-title">Encuentra tu Cancha</h1>
            <p class="text-muted">Explora, elige y reserva la cancha perfecta para tu próximo partido.</p>
        </div>

        <div class="client-dashboard-grid">
            {% for cancha in canchas %}
                <div class="cancha-card-client">
                    <div class="cancha-image">
                        {% if cancha.foto_principal %}
                            <img src="{{ cancha.foto_principal.imagen.url }}" alt="{{ cancha.nombre }}">
                        {% else %}
                            <div class="no-photo"></div>
                        {% endif %}
                        <span class="price-tag">${{ cancha.precio_hora|floatformat:0 }}/hr</span>
                    </div>
                    <div class="cancha-content">
                        <h3>{{ cancha.nombre }}</h3>
                        <small class="text-muted">{{ cancha.empresa.nombre }}</small>
                    </div>
                    <div class="disponibilidad-section">
                        <h4>Horarios Disponibles</h4>
                        <div class="disponibilidad-list-client">
                            {% for d in cancha.disponibilidades.all %}
                                {% if d.estado == 'LIBRE' %}
                                    <div class="disponibilidad-item-client">
                                        <span>{{ d.fecha|date:"D, d M" }} - {{ d.hora_inicio|time:"H:i" }}</span>
                                        <button class="btn-reservar" onclick="reservarHorario('{{ d.id }}', this)">
                                            Reservar
                                        </button>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                </div>
            {% empty %}
                <div class="alert-box">
                    <p>No hay canchas disponibles en este momento.</p>
                </div>
            {% endfor %}
        </div>
    </div>
{% endblock %}

{% block scripts %}
    {{ block.super }} {# Hereda los scripts de base.html #}
    <script>
        async function reservarHorario(id, btnElement) {
            if (!confirm('¿Confirmar reserva para este horario?')) return;

            const originalText = btnElement.innerText;
            btnElement.disabled = true;
            btnElement.innerText = 'Reservando...';

            try {
                const response = await fetch("{% url 'api_reservar' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({disponibilidad_id: id})
                });

                const data = await response.json();

                if (data.success) {
                    // Cambiar UI visualmente sin recargar
                    const item = btnElement.closest('.disponibilidad-item-client');
                    item.innerHTML = '<span class="text-success"><i class="fa-solid fa-check"></i> Reservado</span>';
                    // Opcional: Mostrar notificación toast
                } else {
                    alert('Error: ' + data.message);
                    btnElement.disabled = false;
                    btnElement.innerText = originalText;
                }
            } catch (error) {
                console.error(error);
                alert('Ocurrió un error de conexión');
                btnElement.disabled = false;
                btnElement.innerText = originalText;
            }
        }
    </script>
{% endblock %}